---
title: "Getting started with scIso"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{getting-started}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## 1. Overview

scIso provides tools to analyse isoform usage in single-cell long-read
RNA-seq. Starting from an isoform count matrix and a standard Seurat
object, scIso:

-   computes isoform-level metrics (Percent Inclusion, PI;
    heterogeneity, PHI),

-   visualises isoform usage on embeddings,

-   links isoform dynamics to pseudotime.

This vignette demonstrates a minimal end-to-end workflow using an
example MPNST dataset downloaded from Zenodo.

> ### Workflow summary
>
> -   Load isoform counts and metadata (cell-type annotation,
>     pseudotime).
>
> -   Build a Seurat object and perform standard preprocessing.
>
> -   Visualise clusters and cell-type annotation.
>
> -   Compute and explore PI/PHI from an isoform count matrix.
>
> -   Project isoform usage on embeddings and along pseudotime.
>
> -   Briefly indicate how to adapt the workflow to your own data.

## 2. Load packages

We load scIso together with the core dependencies used in this vignette.

```{r setup}
library(scIso)
library(dplyr)
```

## 3. Load example data from Zenodo

We use a pre-computed cell-type annotation, a pseudotime vector and an
isoform count matrix hosted on Zenodo.

```{r load_data}
cell_types <- readRDS(gzcon(
  url("https://zenodo.org/records/17585277/files/Cell_type_annotation.rds")))

pseudotime <- readRDS(gzcon(
  url("https://zenodo.org/records/17654917/files/Pseudotime_2020_23.rds")))

if (curl::has_internet()) {
  tmp <- tempfile(fileext = ".zip")
  curl::curl_download("https://zenodo.org/records/17585277/files/iso_matrix.zip?download=1", tmp)
  unzip(tmp, exdir = tempdir())
  scmat_iso <- Seurat::Read10X(data.dir = tempdir())
}
```

## 4. Build a Seurat object

We construct a Seurat object using the isoform counts as a dedicated
assay and apply a standard preprocessing pipeline (normalisation,
variable feature selection, PCA, UMAP/t-SNE, neighbour graph,
clustering).

```{r init_sobj}
assay = "ISO"
iso_assay = Seurat::CreateAssayObject(counts = scmat_iso)
seurat_obj = Seurat::CreateSeuratObject(counts = iso_assay,
                                        assay = assay,
                                        project.name = sample_name)

seurat_obj[[paste0('log_nCount_', assay)]] = log(seurat_obj[[paste0('nCount_', assay)]])

seurat_obj
head(rownames(seurat_obj@assays$ISO$counts))
```

```{r normalization}
seurat_obj = Seurat::NormalizeData(seurat_obj,
                                   normalization.method = "LogNormalize",
                                   assay = "ISO",
                                   verbose=F)

seurat_obj = Seurat::FindVariableFeatures(seurat_obj,
                                          assay = "ISO",
                                          nfeatures = 3000,
                                          verbose=F)
seurat_obj
```

```{r filter_cells}
common_cells <- intersect(colnames(seurat_obj), names(cell_types))
seurat_obj <- seurat_obj[,common_cells]
```

```{r set_assay}
Seurat::DefaultAssay(seurat_obj) = "ISO"
ndims = 18
```

```{r dim_reduction}
seurat_obj = Seurat::ScaleData(seurat_obj,
                               features = rownames(seurat_obj), 
                               verbose = F)

var_features = Seurat::VariableFeatures(object = seurat_obj)

seurat_obj = Seurat::RunPCA(seurat_obj, 
                            features = var_features,
                            verbose = F, 
                            reduction.name = "RNA_pca", 
                            max_dims = 100)

seurat_obj = Seurat::RunUMAP(seurat_obj,
                             reduction = "RNA_pca",
                             dims = 1:ndims,
                             seed.use = 1337L,
                             verbose = F,
                             reduction.name = paste0("RNA_pca_", ndims, "_umap"))

seurat_obj = Seurat::RunTSNE(seurat_obj,
                             reduction = "RNA_pca",
                             dims = 1:ndims,
                             seed.use = 1337L,
                             verbose = F,
                             reduction.name = paste0("RNA_pca_", ndims, "_tsne"))

seurat_obj
```

```{r clustering}
seurat_obj = Seurat::FindNeighbors(seurat_obj, reduction = "RNA_pca", dims = c(1:ndims))
seurat_obj = Seurat::FindClusters(seurat_obj, resolution = 0.5)
```

## 5. Add cell-type annotation

We now bring in the external cell-type labels and overlay them on the
embedding.

```{r cell_annotation}
cell_types_named <- levels(cell_types)[cell_types]
names(cell_types_named) <- names(cell_types)

seurat_obj$cell_types <- NA_character_
seurat_obj$cell_types[common_cells] <- cell_types_named[common_cells]
```

```{r cell_viz, fig.height=4, fig.width=12}
proj <- "tsne"
Seurat::DimPlot(seurat_obj, reduction = paste0("RNA_pca_18_", proj), label = T) +
                      ggplot2::labs(title = paste0(proj,"\n", "MPNST"),
                                    subtitle = paste0(ncol(seurat_obj), " cells")) +
                      Seurat::NoAxes() +
                      ggplot2::theme(aspect.ratio = 1,
                                     plot.title = ggplot2::element_text(hjust = 0.5),
                                     plot.subtitle = ggplot2::element_text(hjust = 0.5)) |

            Seurat::DimPlot(seurat_obj, reduction = paste0("RNA_pca_18_", proj), group.by = "cell_types") +
                    ggplot2::labs(title = paste0(proj,"\n", "MPNST"),
                                  subtitle = paste0(ncol(seurat_obj), " cells")) +
                    Seurat::NoAxes() +
                    ggplot2::theme(aspect.ratio = 1,
                                   plot.title = ggplot2::element_text(hjust = 0.5),
                                   plot.subtitle = ggplot2::element_text(hjust = 0.5))
#p_clusters | p_annot
```

## 6. Explore isoform PI/PHI

scIso uses PI (Percent Inclusion) and PHI (heterogeneity) to summarise
isoform usage per gene. For speed, we load a pre-computed PI matrix, but
the same result can be obtained with computePIMatrix() on the fly.

```{r compute_pi_mtx}
#pi_mtx <- scIso::computePIMatrix(seurat_obj, 
#                                 assay = "ISO",
#                                 slot = "count")
```

```{r load_pi_matrix}
if (curl::has_internet()) {
  tmp <- tempfile(fileext = ".rds")
  curl::curl_download("https://zenodo.org/records/17585277/files/pi_mtx.rds?download=1", tmp)
  pi_mtx <- readRDS(tmp)
}
```

```{r plot_pi}
scIso::plotPIPHI(pi_mat = pi_mtx,
                 iso_mat = seurat_obj@assays$ISO$counts,
                 min_gene_count = 3000
                 )
```

## 7. Visualise isoform usage

We next contrast two isoforms of Srsf3 on the t-SNE embedding, using
FeaturePlotPI(). This function computes PI for the selected isoforms and
displays PI and log-ratio at the single-cell level.

```{r plot_ration_and_pi_dist, fig.height=4, fig.width=12}
p <- scIso::FeaturePlotPI(seurat_obj, 
                     name = "Srsf3", 
                     reduction = paste0("RNA_pca_18_", proj),
                     iso1 = "Srsf3..ENSMUST00000130216",
                     iso2 = "Srsf3..ENSMUST00000037776")
p[[1]] | p[[3]] | p[[4]]
```

```{r plot_iso, fig.height=4, fig.width=12}
p[[1]] | p[[2]]
```

## 8. Restrict to tumour cells and add pseudotime

We focus on tumour cells, refine the annotation, and add the pseudotime
trajectory previously inferred for this dataset.

```{r annot_clusters}
major <- seurat_obj@meta.data %>%
            group_by(seurat_clusters) %>%
            summarise(cell_annotation=names(which.max(table(cell_types))))

idx <- match(seurat_obj@meta.data$seurat_clusters, major$seurat_clusters)
seurat_obj$cell_pop <- major$cell_annotation[idx]
```

```{r annot_subpopulations}
seurat_obj <- subset(seurat_obj, subset = cell_pop == "tumor cells")

seurat_obj$tumor_cell_type <- ifelse(seurat_obj$seurat_clusters == 4, "Sox10+", "Sox9+")
seurat_obj$tumor_cell_type <- ifelse(seurat_obj$seurat_clusters == 4, "Sox10+", "Sox9+")
```

```{r assign_pstime}
names(pseudotime) <- sub(".*_", "", names(pseudotime))

seurat_obj$pseudotime <- pseudotime
```

```{r viz_cells_annotations, fig.height=4, fig.width=12}
Seurat::DimPlot(seurat_obj, reduction = paste0("RNA_pca_18_", proj), group.by = "cell_pop") +
                    ggplot2::labs(title = paste0(proj,"\n", "MPNST"),
                                  subtitle = paste0(ncol(seurat_obj), " cells")) +
                    Seurat::NoAxes() +
                    ggplot2::theme(aspect.ratio = 1,
                                   plot.title = ggplot2::element_text(hjust = 0.5),
                                   plot.subtitle = ggplot2::element_text(hjust = 0.5)) |
  
  
  Seurat::DimPlot(seurat_obj, reduction = paste0("RNA_pca_18_", proj), group.by = "tumor_cell_type") +
                    ggplot2::labs(title = paste0(proj,"\n", "MPNST"),
                                  subtitle = paste0(ncol(seurat_obj), " cells")) +
                    Seurat::NoAxes() +
                    ggplot2::theme(aspect.ratio = 1,
                                   plot.title = ggplot2::element_text(hjust = 0.5),
                                   plot.subtitle = ggplot2::element_text(hjust = 0.5)) |
  
  
  Seurat::FeaturePlot(seurat_obj, features = "pseudotime",
                    reduction = paste0("RNA_pca_18_", proj)) +
  ggplot2::scale_color_gradientn(colors = rev(RColorBrewer::brewer.pal(name = "Spectral", n = 10))) +
  ggplot2::ggtitle("Pseudotime") +
  ggplot2::theme(aspect.ratio = 1,
                 plot.title = ggplot2::element_text(hjust = 0.5)) +
  Seurat::NoAxes()
```

## 9. Isoform dynamics along pseudotime

IsoformPseudotimePlot() summarises isoform usage for a given gene across
pseudotime bins and optionally stratified by cell groups.

```{r plot_pstime, fig.height=3, fig.width=10}
scIso::IsoformPseudotimePlot(seurat_obj, 
                             gene = "Dnaja1",
                             band_cols = "tumor_cell_type",
                             pseudotime_col = "pseudotime",
                             nbins = 80,
                             mode = "PI",
                             slot = "data")
```

```{r fig.height=3, fig.width=10}
scIso::IsoformPseudotimePlot(seurat_obj, 
                             gene = "Dnaja1",
                             band_cols = c("tumor_cell_type", "tumor_cell_type"),
                             pseudotime_col = "pseudotime", 
                             nbins = 30,
                             mode = "exp",
                             slot = "data")
```

## 10. Using scIso on your own data

-   To apply this workflow to your own dataset:

-   replace the example isoform matrix with your own (features =
    isoforms or isoform-level identifiers, columns = cells/barcodes);

-   construct a Seurat object with an isoform assay (e.g. "ISO") and
    follow your preferred preprocessing strategy;

-   compute PI using computePIMatrix() on your isoform count matrix;

-   add any relevant metadata (cell types, clusters, trajectories) to
    [seurat_obj\@meta.data](mailto:seurat_obj@meta.data){.email};

-   use plotPIPHI(), FeaturePlotPI() and IsoformPseudotimePlot() to
    interrogate isoform heterogeneity and dynamics.

```{r rsession}
sessionInfo()
```
